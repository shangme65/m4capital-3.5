# Deployment Guide

## Vercel Deployment (Recommended)

### Prerequisites

- Vercel account
- GitHub repository connected
- PostgreSQL database (Neon, Supabase, Railway, etc.)

### Steps

#### 1. Link Project

```bash
vercel link
```

#### 2. Configure Environment Variables

Add these in Vercel Dashboard under Settings â†’ Environment Variables:

- `DATABASE_URL`
- `NEXTAUTH_URL` (your production domain)
- `NEXTAUTH_SECRET`
- `SEED_ADMIN_EMAIL` (optional)
- `SEED_ADMIN_PASSWORD` (optional)

Or pull locally:

```bash
vercel env pull .env.local
```

#### 3. Deploy

```bash
vercel --prod
```

Or push to main branch (auto-deploy if connected).

#### 4. Run Migrations

After first deployment:

```bash
# Using Vercel CLI
vercel env pull
npx prisma migrate deploy

# Or run seed if needed
npm run seed
```

---

## Railway Deployment

### 1. Create New Project

- Connect GitHub repository
- Add PostgreSQL service

### 2. Configure Environment Variables

Add in Railway dashboard:

- `DATABASE_URL` (auto-generated by Railway)
- `NEXTAUTH_URL`
- `NEXTAUTH_SECRET`
- Other variables from `.env.example`

### 3. Deploy

Railway auto-deploys on git push.

---

## Docker Deployment

### Dockerfile

Create `Dockerfile`:

```dockerfile
FROM node:20-alpine AS base

# Dependencies
FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package*.json ./
RUN npm ci

# Builder
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npx prisma generate
RUN npm run build

# Runner
FROM base AS runner
WORKDIR /app
ENV NODE_ENV production

RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

USER nextjs
EXPOSE 3000
ENV PORT 3000

CMD ["node", "server.js"]
```

### Build and Run

```bash
docker build -t m4capital .
docker run -p 3000:3000 --env-file .env.local m4capital
```

---

## Manual VPS Deployment

### 1. Server Setup

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Node.js 20
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt install -y nodejs

# Install PM2
sudo npm install -g pm2
```

### 2. Deploy Application

```bash
# Clone repository
git clone https://github.com/shangme65/m4capital-3.5.git
cd m4capital-3.5

# Install dependencies
npm install

# Setup environment
cp .env.example .env.local
# Edit .env.local with production values

# Run migrations
npx prisma migrate deploy
npm run seed

# Build
npm run build

# Start with PM2
pm2 start npm --name "m4capital" -- start
pm2 save
pm2 startup
```

### 3. Nginx Reverse Proxy

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 4. SSL with Certbot

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

---

## Database Hosting Options

### Neon (Recommended)

- Serverless PostgreSQL
- Free tier available
- Auto-scaling
- https://neon.tech

### Supabase

- PostgreSQL with additional features
- Free tier available
- https://supabase.com

### Railway

- Managed PostgreSQL
- Simple setup
- https://railway.app

### PlanetScale

- MySQL (requires schema changes)
- Free tier available
- https://planetscale.com

---

## Post-Deployment Checklist

- [ ] Environment variables configured
- [ ] Database migrations run
- [ ] Admin user seeded
- [ ] Domain configured
- [ ] SSL certificate active
- [ ] Health check passing
- [ ] Monitoring setup (optional)
- [ ] Backup strategy implemented

---

## Monitoring

### Vercel Analytics

Enable in Vercel dashboard for automatic monitoring.

### Custom Monitoring

Consider adding:

- Sentry for error tracking
- LogRocket for session replay
- Uptime monitoring (UptimeRobot, Pingdom)

---

## Rollback Procedure

### Vercel

```bash
vercel rollback
```

Or use dashboard to redeploy previous version.

### PM2 (VPS)

```bash
# Stop current
pm2 stop m4capital

# Pull previous version
git reset --hard <commit-hash>
npm install
npm run build

# Restart
pm2 restart m4capital
```
